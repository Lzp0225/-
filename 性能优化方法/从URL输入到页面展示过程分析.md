在工作过程中不知道大家有没有遇到这样的情况，团队（boss）对首屏时间的要求是1200ms，目前首屏时间长达好几秒，甚至十多秒，离要求还有不小的差距。
为此，你精简了首屏的内容，合并了请求资源，对图片的尺寸也进行了压缩优化，但最后首屏时间还是没有降下来，为什么？

实际上，要对web前端进行性能优化，除了了解性能体系，关键性能指标之外，还需了解页面加载全过程。通过这个过程，我们可以找到其中影响性能的关键点，接下来才明白在哪里进行优化。

###页面加载大致的过程是怎样的？

当用户向浏览器中输入URL并回车后，首先浏览器会向DNS服务器发起DNS查询，得到IP地址；然后浏览器通过IP地址找到目标服务器，发起TCP三次握手和TLS协商，从而建立起TCP连接。
建立连接后，浏览器会发起http请求，服务器做出响应并返回数据给到浏览器，浏览器将得到的数据进行解析和渲染，随后在用户面前出现了一个网页。

以上的整个过程可以分为3个部分：客户端发起请求阶段、服务端数据处理阶段、客户端渲染阶段。

###客户端请求阶段

这一阶段是指用户在浏览器输入URL，经过本地缓存确认是否存在这个网站，如果没有，接着由DNS查询从域名服务器获取这个IP地址，接下来就是建立TCP三次握手和TLS协商向服务器发起http请求建立连接的过程

####本地缓存

我们知道，本地缓存可以让静态资源加载更快，客户端发起请求时，静态资源可以直接从客户端中获取，不需要向服务端发送请求。而想要本地缓存发挥这个作用，就需要先在服务器上配置。

所谓缓存，基本就是指强缓存和协商缓存。

####强缓存
强缓存是指客户端发送请求后，根据请求头的expire、cache-control判断是否命中客户端缓存，如果命中则直接从客户端中获取，如果没有命中强缓存规则那么就进入下一步协商缓存。

####协商缓存
协商缓存是指客户端第一次请求后，服务端在响应头中发送了ETag(最近修改时间的哈希值或者是版本号)、Last-Modified（请求资源上次更新的时间），浏览器会缓存下这个时间；
然后在下次请求中，request header会带上If-None-Modified(缓存的Etag)、If-Modified-Since（缓存的Last-Modified），
根据浏览器发送的这些标识和服务器最近修改的标识进行对比，一致的话代表资源没有改变，服务端只返回头部信息，同时给定状态码304通知浏览器去缓存中获取资源；
如果不一致则从服务器重新获取资源。

以上总结：强缓存只有在缓存命中时不会去请求服务器；协商缓存无论什么结果都会去请求服务器，同时缓存命中的话服务端不会返回正文（即response没有内容），只会返回response header并且状态码为304。

####DNS查询

每一次DNS查询，都要经过从手机到信号塔，再到认证DNS服务器，这中间需要很长的时间。但是用户是不想等待的。
想要节省时间，就要想办法让DNS查询走缓存。而浏览器就提供了DNS预获取的接口，我们在打开浏览器的同时进行配置。
这样真正请求时，DNS域名解析就会检查浏览器缓存，一旦缓存命中，就不需要去DNS服务器查询了。
如果浏览器没有配置缓存就会去操作系统中查询(host)-->路由器缓存-->本地DNS缓存,以上都没有找到则去根域名服务器查询。

###服务端数据处理阶段

这个阶段只是web服务器接收到请求后，从数据存储层取到数据，再返回给前端的过程。

具体来说，服务端程序接收到http请求后，会做一些请求参数处理以及权限校验，检验完成后，它会将请求参数发送到数据存储服务，然后服务端程序会从数据存储中取到数据，
进行数据加工聚合处理，最后再通过jsonp或ajax接口返回给前端。

这个过程中的优化点，在于是否做了数据缓存，Gzip压缩，以及是否有重定向。

其中Gzip压缩是一种压缩技术，服务端通过使用Gzip，对传输到浏览器的文本类数据进行压缩，体积可达到原来的1/3左右，这样可以减少下载资源的时间，能大大的提升页面的展示速度。

####数据缓存

数据缓存主要分为两种：借助Service Worker的数据缓存接口、借助本地存储和CDN。

Service Worker的数据缓存接口：Service Worker是浏览器的一个高级属性，本质上就是一个请求代理层，它存在的目的就是拦截和处理网络数据请求。
如果没有Service Worker每次请求都会直接到达webServer，需要走一次后端的数据存取链路的流程，这会延长页面打开的时间。

本地存储可以将需要持久化的数据保存在本地，客户端先去本地存储查询，没有找到就去服务端请求。

CDN，它的基本思路是，通过在网络各处放置节点服务器，构造一个智能虚拟网络，将用户的请求向导到最近的网络服务节点上；
比如一个深圳的用户想访问北京门户的网站，如果没有使用CDN，静态资源的服务器可能在北京，这样传输时间比较长，导致资源请求时间过长。
如果使用CDN，因为CDN的节点遍布全国，它就可以选择距离深圳最近的网络节点返回静态资源。

###客户端渲染阶段

在页面加载过程中，当前服务端对数据进行聚合加工后返回给前端，当客户端拿到数据后开始交给浏览器渲染引擎解析和渲染。

所谓解析就是HTML解析器把页面内容转换成DOM树和CSSOM树的过程

DOM树描述了标签的层次和结构，CSSOM描述了样式的层次和结构；解析完后就是渲染，主线程会计算DOM节点的最终样式，生成布局树；
布局树会记录参与页面布局的样式和几何位置。这一过程会造成重排重绘
=======================================


